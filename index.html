<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gimbocha KDS - Standardized Training</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --brand: #8c5b3e; --bg: #1a1a1a; --hot: #e65100; --single: #c62828; --blended: #2e7d32; --dessert: #fbc02d; --success: #4caf50; --danger: #f44336; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg); margin: 0; padding: 2svh 2vw; display: flex; justify-content: center; align-items: center; height: 100svh; width: 100vw; overflow: hidden; box-sizing: border-box; touch-action: none; }
        #app { background: #f4f4f4; width: 100%; height: 100%; display: flex; flex-direction: column; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 4px 12px; background: #111; color: #fff; font-size: 13px; font-weight: bold; flex-shrink: 0; border-bottom: 2px solid var(--brand); }
        .game-container { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        .order-panel-wrapper { display: flex; flex: 1; overflow: hidden; border-bottom: 3px solid #ccc; }
        .order-panel { flex: 1; padding: 8px; background: #eceff1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .order-header { font-size: 12px; font-weight: bold; color: #333; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;}
        
        @keyframes popInOrder { 0% { transform: scale(0.8) translateY(-20px); opacity: 0; } 100% { transform: scale(1) translateY(0); opacity: 1; } }
        #tickets-container { display: flex; gap: 8px; overflow-x: auto; overflow-y: hidden; padding-bottom: 5px; flex-grow: 1; align-items: flex-start; scroll-behavior: smooth; }
        #tickets-container::-webkit-scrollbar { height: 5px; }
        #tickets-container::-webkit-scrollbar-thumb { background: #bbb; border-radius: 3px; }

        .ticket { background: white; border: 2px solid #ddd; padding: 6px; border-radius: 6px; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); min-width: 155px; max-width: 155px; flex-shrink: 0; display: flex; flex-direction: column; max-height: 100%; overflow-y: auto; position: relative; transition: 0.3s; animation: popInOrder 0.3s forwards; }
        .ticket.ready { background: #e8f5e9; border-color: var(--success) !important; }
        .ticket.ready h3 { color: var(--success) !important; border-bottom-color: var(--success); }
        .ready-stamp { background: var(--success); color: white; text-align: center; font-size: 11px; font-weight: bold; padding: 3px; border-radius: 4px; margin-bottom: 5px; }

        .ticket h3 { margin: 0 0 4px 0; color: #111; display: flex; justify-content: space-between; font-size: 11px; border-bottom: 1px dashed #ccc; padding-bottom: 3px;}
        .ticket-timer-bg { width: 100%; height: 4px; background: #eee; border-radius: 2px; margin-bottom: 5px; overflow: hidden; }
        .ticket-timer-fill { height: 100%; background: var(--success); width: 100%; transition: width 1s linear, background-color 0.5s; }
        
        .order-item { display: flex; align-items: center; margin-bottom: 3px; font-size: 9px; font-weight: 500; line-height: 1.2; }
        .order-item.done { text-decoration: line-through; color: #aaa; opacity: 0.5; }
        .badge { display: inline-block; padding: 2px 3px; border-radius: 3px; font-size: 8px; color: white; margin-right: 4px; font-weight: bold; min-width: 25px; text-align: center; }
        .bg-single { background: var(--single); } .bg-blended { background: var(--blended); } .bg-hot { background: transparent; font-size: 11px; padding: 0; min-width: 20px; } .bg-dessert { background: var(--dessert); color: #333; }

        .serve-panel { width: 75px; background: #d7ccc8; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px; border-left: 3px solid var(--brand); box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 10; }
        .serve-btn { width: 100%; height: 80%; background: var(--success); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 12px; cursor: pointer; box-shadow: 0 4px 0 #2e7d32; transition: 0.1s; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .serve-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #2e7d32; }
        .serve-btn.disabled { background: #9e9e9e; box-shadow: 0 4px 0 #616161; cursor: not-allowed; opacity: 0.7;}
        
        .station-panel { flex: 0 0 42%; padding: 6px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; background: #fff; }
        .station { background: #f9f9f9; border: 1px solid #ddd; padding: 6px; border-radius: 6px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; }
        .station h4 { margin: 0 0 2px 0; font-size: 10px; }
        .station p { font-size: 8px; margin: 0; color: #666; }
        .btn-action { width: 100%; padding: 6px; border: none; border-radius: 5px; font-family: inherit; font-size: 10px; font-weight: bold; cursor: pointer; color: white; transition: 0.1s; margin-top: 3px; }
        .btn-action:disabled { background: #ccc !important; cursor: not-allowed; }
        
        .machine-slots { display: flex; flex-direction: column; gap: 2px; margin-top: 3px; }
        .slot-bar { width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; position: relative; }
        .slot-fill { height: 100%; width: 0%; background: var(--single); transition: width linear; }
        .slot-text { position: absolute; width: 100%; text-align: center; font-size: 6px; color: white; line-height: 8px; font-weight: bold; top: 0; }
        .progress-bar { width: 100%; height: 6px; background: #eee; border-radius: 3px; margin-top: 3px; overflow: hidden; display: none; }
        .progress-fill { width: 0%; height: 100%; transition: width linear; }
        .stock-indicator { font-size: 10px; font-weight: bold; color: var(--blended); margin: 2px 0; }
        
        .score-popup { position: absolute; color: var(--success); font-weight: bold; font-size: 12px; animation: floatUp 1s forwards; pointer-events: none; z-index: 50; text-shadow: 1px 1px white;}
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-25px); } }
        .hidden { display: none !important; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; text-align: center; padding: 5px 10px; box-sizing: border-box;}
        .overlay h1 { font-size: 16px !important; margin: 0 0 2px 0; text-shadow: 1px 1px var(--brand); }
        .overlay p { font-size: 10px !important; margin: 2px 0; color: #ddd; }
        .btn-primary { background: var(--brand); color: white; padding: 6px 10px; border: none; border-radius: 6px; font-size: 11px; font-family: inherit; cursor: pointer; margin: 2px; font-weight: bold; transition: 0.2s; }
        .btn-primary.btn-capture { background: var(--single); font-size: 11px; padding: 4px 8px; margin-top: 3px;}
        .btn-danger { background: var(--danger); }
        .split-layout { display: flex; flex-direction: row; align-items: stretch; justify-content: center; width: 100%; max-width: 600px; gap: 10px; height: 100%; max-height: 250px; }
        .split-left { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative;}
        .split-right { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden;}
        
        .input-name { padding: 4px; width: 80%; max-width: 180px; margin: 4px 0; border-radius: 6px; border: 2px solid var(--brand); text-align: center; font-family: inherit; font-size: 11px; outline: none; }
        .leaderboard-container { background: #fff; color: #333; width: 100%; border-radius: 8px; padding: 6px; margin: 0; text-align: left; overflow-y: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.5); flex-grow: 1; display: flex; flex-direction: column;}
        .leaderboard-title { font-size: 10px; font-weight: bold; border-bottom: 2px solid var(--brand); margin-bottom: 3px; padding-bottom: 2px; flex-shrink: 0;}
        #leaderboard-list { overflow-y: auto; flex-grow: 1; }
        .leaderboard-row { display: flex; justify-content: space-between; align-items: center; padding: 3px 0; border-bottom: 1px solid #eee; font-size: 9px; gap: 5px;}
        .leaderboard-row:last-child { border-bottom: none; }
        .lb-rank { font-weight: bold; width: 15px; text-align: center;}
        
        .selfie-wrapper { position: relative; width: 60px; height: 60px; margin-bottom: 4px; border-radius: 12px; border: 2px solid var(--brand); box-shadow: 0 4px 10px rgba(0,0,0,0.5); overflow: hidden; background: #000;}
        #selfie-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); } 
        #selfie-preview { display: none; width: 60px; height: 60px; border-radius: 12px; border: 2px solid var(--brand); margin-bottom: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); object-fit: cover;} 
        .selfie-icon { position: absolute; font-size: 12px; color: rgba(255,255,255,0.7); top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none;}
        
        .player-img-header { width: 22px; height: 22px; border-radius: 50%; border: 1px solid #fff; object-fit: cover; margin-right: 5px;}
        .player-img-lb { width: 18px; height: 18px; border-radius: 4px; border: 1px solid var(--brand); object-fit: cover; margin-right: 4px;}
        .shop-logo-top { width: 60px; height: 60px; object-fit: cover; border-radius: 12px; border: 2px solid var(--brand); margin-bottom: 4px; }
        
        #landscape-warning { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2b2b2b; color: white; z-index: 999; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; }
        @media screen and (orientation: portrait) { #landscape-warning { display: flex; } #app { display: none; } }
        
        .kpi-box { background: rgba(255,255,255,0.1); padding: 5px; border-radius: 8px; margin: 4px 0; width: 100%; border: 1px solid rgba(255,255,255,0.2); }
        .kpi-box p { margin: 1px 0 !important; }
    </style>
</head>
<body>

<div id="landscape-warning">
    <h1 style="color: var(--brand); margin-bottom: 10px;">üì± ‡∏´‡∏°‡∏∏‡∏ô‡∏à‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</h1>
</div>

<div id="app">
    <div class="header">
        <span id="level-display" style="color: #ffd54f;">Level 1</span>
        <span style="display: flex; align-items: center;">
            <img id="header-player-img" src="" alt="Player" class="hidden player-img-header">
            ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <span id="display-player-name" style="color: #fff; margin-left: 3px;">-</span>
        </span>
        <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: <span id="total-score" style="color: #4caf50;">0</span></span>
    </div>

    <div class="game-container">
        <div class="order-panel-wrapper">
            <div class="order-panel">
                <div class="order-header">
                    <span>üßæ ‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå <span id="order-count-badge" style="background: #333; color: white; padding: 2px 6px; border-radius: 6px; font-size: 9px; margin-left: 5px;">‡∏£‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß: 0</span></span>
                    <span id="active-count-badge" style="background: var(--danger); color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px;">‡∏ö‡∏ô‡∏à‡∏≠: 0 ‡∏ö‡∏¥‡∏•</span>
                </div>
                <div id="tickets-container"></div>
                <p id="no-order-msg" class="hidden" style="color: var(--success); font-weight: bold; text-align: center; font-size: 11px; width: 100%; margin-top: 10px;">‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡∏¥‡∏ß‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!</p>
            </div>
            
            <div class="serve-panel">
                <p style="margin: 0 0 3px 0; font-size: 9px; font-weight: bold; color: #555;">‡∏à‡∏±‡∏î‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü</p>
                <button class="serve-btn disabled" id="btn-serve-tray" onclick="serveOrders()">
                    <span style="font-size: 18px; margin-bottom: 2px;">üõéÔ∏è</span> ‡∏Å‡∏î‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü
                    <span style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 2px 6px; margin-top: 3px; font-size: 9px;"><span id="ready-count">0</span> / 4</span>
                </button>
            </div>
        </div>

        <div class="station-panel">
            <div class="station" style="border-color: var(--hot);">
                <div><h4 style="color: var(--hot);">ü´ñ 1. Hot Tea</h4><p>‡∏ä‡∏á+‡∏™‡∏≠‡∏ô (5 ‡∏ß‡∏¥)</p></div>
                <div>
                    <button class="btn-action bg-hot" style="background: #e65100;" id="btn-hot" onclick="doTask('hot', 5000, 'btn-hot')">‡∏ä‡∏á‡∏ä‡∏≤‡∏£‡πâ‡∏≠‡∏ô</button>
                    <div class="progress-bar" id="prog-hot"><div class="progress-fill" style="background: #e65100;" id="fill-hot"></div></div>
                </div>
            </div>
            <div class="station" style="border-color: var(--single);">
                <div><h4 style="color: var(--single);">üçµ 2. Single Iced</h4><p>‡∏ä‡∏á‡∏™‡∏î 4 ‡∏´‡∏±‡∏ß (8 ‡∏ß‡∏¥)</p></div>
                <div class="machine-slots" id="single-slots"></div>
                <button class="btn-action bg-single" id="btn-single" onclick="brewSingleTea()">‡∏Å‡∏î‡∏ä‡∏á 1 ‡πÅ‡∏Å‡πâ‡∏ß</button>
            </div>
            <div class="station" style="border-color: var(--blended);">
                <div><h4 style="color: var(--blended);">üßã 3. Blended</h4><p>‡∏ï‡πâ‡∏°‡πÅ‡∏Å‡∏•‡∏•‡∏≠‡∏ô (10 ‡∏ß‡∏¥)</p></div>
                <div class="stock-indicator">‡∏™‡∏ï‡πá‡∏≠‡∏Ñ: <span id="blended-stock" style="font-size: 12px;">4</span>/4</div>
                <div>
                    <button class="btn-action bg-blended" id="btn-blend-pour" onclick="pourBlended()">‡πÄ‡∏ó‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü</button>
                    <button class="btn-action" style="background: #ff9800; font-size: 9px; padding: 4px; opacity: 0.5;" id="btn-blend-refill" onclick="refillGallon()">‡∏ï‡πâ‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                    <div class="progress-bar" id="prog-refill"><div class="progress-fill" style="background: #ff9800;" id="fill-refill"></div></div>
                </div>
            </div>
            <div class="station" style="border-color: var(--dessert);">
                <div><h4 style="color: var(--dessert);">üç∞ 4. Dessert</h4><p>‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô (2 ‡∏ß‡∏¥)</p></div>
                <div>
                    <button class="btn-action bg-dessert" id="btn-dessert" onclick="doTask('dessert', 2000, 'btn-dessert')">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡∏ô‡∏°</button>
                    <div class="progress-bar" id="prog-dessert"><div class="progress-fill bg-dessert" id="fill-dessert"></div></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="overlay-start" class="overlay">
    <img src="IMG_4511.jpeg" alt="Gimbocha Logo" class="shop-logo-top" onerror="this.style.display='none'">
    <h1 style="color: #fff;">Gimbocha KDS</h1>
    <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>
    
    <div class="selfie-wrapper" id="selfie-wrapper">
        <span class="selfie-icon">üì∑</span>
        <video id="selfie-video" autoplay playsinline></video>
    </div>
    <img id="selfie-preview" src="" alt="Selfie Preview">
    
    <button class="btn-primary btn-capture" id="btn-capture" onclick="takeSelfie()">‡∏Å‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏ü‡∏µ‡πà</button>
    <input type="text" id="player-name-input" class="input-name" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." autocomplete="off">
    
    <div class="button-group">
        <button class="btn-primary" id="btn-start" onclick="initGame()" disabled style="opacity: 0.5;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</button>
    </div>
    <canvas id="selfie-canvas" style="display: none;"></canvas>
</div>

<div id="overlay-level-clear" class="overlay hidden">
    <div class="split-layout">
        <div class="split-left">
            <h1 id="clear-title" style="color: var(--success); font-size: 16px !important; margin: 0 0 2px 0;">‡∏î‡πà‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå!</h1>
            <p style="margin: 0; color: #fff; font-size: 10px;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ: <span id="level-score-display" style="color: #ffd54f; font-size: 14px; font-weight: bold;">0</span></p>
            
            <div class="kpi-box">
                <p style="font-size: 9px; color: #ddd;">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ: <span id="avg-time-game" style="color: #fff; font-weight: bold;">0</span> ‡∏ß‡∏¥/‡∏ö‡∏¥‡∏•</p>
                <p style="font-size: 11px; color: #ffd54f; margin-top: 2px !important;">‚è≥ ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <span id="avg-time-real" style="font-weight: bold; font-size: 13px;">0</span> ‡∏ô‡∏≤‡∏ó‡∏µ/‡∏ö‡∏¥‡∏•</p>
                <p style="font-size: 8px; color: #aaa;">(‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ: ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 15 ‡∏ô‡∏≤‡∏ó‡∏µ)</p>
                
                <hr style="border: 0; border-top: 1px dashed rgba(255,255,255,0.2); margin: 4px 0;">
                
                <p style="font-size: 9px; color: #4caf50;">üåç ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∑‡πà‡∏ô <span id="lbl-level-avg" style="color:#fff;">(‡πÉ‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ)</span>: <span id="global-avg-time" style="font-weight: bold; color: #fff;">...</span> ‡∏ô‡∏≤‡∏ó‡∏µ</p>
                <p id="kpi-compare-status" style="font-size: 9px; font-weight: bold; margin-top: 2px !important;"></p>
            </div>

            <div class="button-group hidden" id="action-buttons">
                <button class="btn-primary btn-danger" onclick="location.reload()">‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å (‡∏≠‡∏≠‡∏Å)</button>
                <button class="btn-primary" onclick="startNextLevel()" id="btn-continue">‡∏•‡∏∏‡∏¢‡∏î‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ!</button>
            </div>
        </div>

        <div class="split-right">
            <div class="leaderboard-container">
                <div class="leaderboard-title" id="lb-title">üèÜ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏ô‡∏ä‡∏á‡πÑ‡∏ß (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ)</div>
                <div id="leaderboard-list"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // üî¥ URL ‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏™ üî¥
    const GOOGLE_APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwmjGRY-8-BVfAOZJ1ivA_lEY3e6mPu37ZW_ifvdvVtNShVHhdFAEJ4yoIvgjvmPKR9/exec";

    const menuDB = {
        hot: ["‡∏≠‡∏±‡∏™‡∏™‡∏±‡∏°‡∏ß‡∏≤‡∏ß‡∏µ", "‡∏ä‡∏≤‡∏°‡∏∞‡∏•‡∏¥‡∏´‡∏¥‡∏°‡∏∞‡πÇ‡∏õ‡∏£‡∏¢", "‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏á‡∏ä‡∏≤‡∏ô", "‡∏´‡∏•‡∏á‡∏à‡∏¥‡πà‡∏á 2025", "‡πÄ‡∏ñ‡∏µ‡πà‡∏¢‡∏Å‡∏ß‡∏ô‡∏≠‡∏¥‡∏ô", "‡∏à‡∏≤‡∏á‡∏ú‡∏¥‡∏á‡∏™‡∏∏‡πà‡∏¢‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô", "‡∏ï‡πâ‡∏≤‡∏´‡∏á‡πÄ‡∏ú‡∏≤", "‡∏™‡∏∏‡πà‡∏¢‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô‡∏≠‡∏ö‡∏ñ‡πà‡∏≤‡∏ô"],
        single: ["‡∏ä‡∏≤‡∏Ç‡∏≤‡∏ß‡πÄ‡∏Å‡πá‡∏ö 8 ‡∏õ‡∏µ", "‡∏ä‡∏≤‡∏°‡∏∞‡∏•‡∏¥‡∏´‡∏¥‡∏°‡∏∞‡πÇ‡∏õ‡∏£‡∏¢", "‡∏ä‡∏≤‡πÅ‡∏î‡∏á‡∏ß‡∏≤‡∏ß‡∏µ", "‡∏ï‡∏≤‡∏ô‡∏â‡∏á‡πÄ‡∏Å‡∏•‡πá‡∏î‡∏´‡∏¥‡∏°‡∏∞", "‡∏°‡∏µ‡πà‡∏´‡∏•‡∏±‡∏ô‡πÄ‡∏ã‡∏µ‡∏¢‡∏á", "‡∏™‡∏∏‡πà‡∏¢‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô", "‡πÄ‡∏à‡∏¥‡πâ‡∏á‡∏ã‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏±‡∏ô‡∏™‡∏ô"],
        blended: ["Cinnamon Mint", "Dark Pomegranate", "8 Flowers", "Kandy!", "Lavender Lemon", "Rock Oolong", "Elder Flower"],
        dessert: ["Blueberry Tart", "Burnt Cheese Cake", "Japanese Cheese Cake", "Lemon Custard", "Orange & Choc Cake", "Dark Choc Tart", "Smoked Salmon Choux", "Strawberry Panna cotta"]
    };

    const levelsConfig = [
        { orders: 5, itemsMin: 1, itemsMax: 2, baseTime: 40 },   
        { orders: 7, itemsMin: 1, itemsMax: 3, baseTime: 45 },   
        { orders: 9, itemsMin: 2, itemsMax: 3, baseTime: 50 },   
        { orders: 11, itemsMin: 2, itemsMax: 4, baseTime: 55 },  
        { orders: 13, itemsMin: 2, itemsMax: 4, baseTime: 60 },  
        { orders: 15, itemsMin: 3, itemsMax: 4, baseTime: 65 },  
        { orders: 17, itemsMin: 3, itemsMax: 5, baseTime: 70 },  
        { orders: 20, itemsMin: 3, itemsMax: 5, baseTime: 75 },  
        { orders: 22, itemsMin: 4, itemsMax: 6, baseTime: 80 },  
        { orders: 25, itemsMin: 4, itemsMax: 6, baseTime: 85 }   
    ];

    let levels = [];
    
    // üü¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡πà‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå" (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏à‡∏≠‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πä‡∏∞‡πÜ ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏î‡πà‡∏≤‡∏ô) üü¢
    function generateStandardLevels() {
        levelsConfig.forEach((config, idx) => {
            let levelOrders = [];
            for(let i = 0; i < config.orders; i++) {
                // ‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô 100% ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
                let numItems = config.itemsMin + ((idx * 3 + i * 7) % (config.itemsMax - config.itemsMin + 1));
                let items = [];
                for(let j=0; j < numItems; j++) {
                    const categories = Object.keys(menuDB);
                    const typeIdx = (idx * 2 + i * 5 + j * 11) % categories.length;
                    const type = categories[typeIdx];
                    const nameIdx = (idx * 7 + i * 13 + j * 17) % menuDB[type].length;
                    const name = menuDB[type][nameIdx];
                    items.push({ type, name, done: false });
                }
                levelOrders.push({ id: `${idx+1}0${i+1}`, timeLimit: config.baseTime, timeLeft: config.baseTime, items: items, status: 'pending' });
            }
            levels.push({ title: `Level ${idx+1}`, orders: levelOrders, spawnBaseRate: Math.max(1, 4 - Math.floor(idx/2)) });
        });
    }
    generateStandardLevels();

    let currentLevel = 0; 
    let totalScore = 0; // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô
    let levelScore = 0; // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏î‡πà‡∏≤‡∏ô (‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡πÅ‡∏Ç‡πà‡∏á‡πÅ‡∏¢‡∏Å‡∏î‡πà‡∏≤‡∏ô)
    let spawnQueue = []; let activeOrders = []; 
    let timeToNextSpawn = 0; let blendedStock = 4; let singleBrewSlots = 0; let globalTimer;
    let playerName = ""; let selfieDataURL = ""; let streamReference = null; 
    
    // üî¥ ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ KPI ‡πÅ‡∏¢‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏î‡πà‡∏≤‡∏ô üî¥
    let levelWaitTimes = [];

    function initSingleSlots() {
        const container = document.getElementById('single-slots');
        container.innerHTML = "";
        for(let i=1; i<=4; i++) {
            container.innerHTML += `<div class="slot-bar"><div class="slot-fill" id="slot-fill-${i}"></div><div class="slot-text" id="slot-text-${i}">‡∏ß‡πà‡∏≤‡∏á</div></div>`;
        }
    }
    initSingleSlots();
    
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user", width: 100, height: 100 }, audio: false });
            const videoEl = document.getElementById('selfie-video');
            videoEl.srcObject = stream;
            streamReference = stream; 
        } catch (err) {
            console.error(err);
            document.getElementById('selfie-wrapper').innerHTML = "<div style='color:#ff9800; font-size:8px; padding:5px;'>‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏•‡πâ‡∏≠‡∏á</div>";
        }
    }
    
    function takeSelfie() {
        const video = document.getElementById('selfie-video'); const canvas = document.getElementById('selfie-canvas');
        const preview = document.getElementById('selfie-preview'); const wrapper = document.getElementById('selfie-wrapper');
        const btnStart = document.getElementById('btn-start'); const btnCapture = document.getElementById('btn-capture');

        if(!streamReference || video.readyState !== 4) return;
        canvas.width = 100; canvas.height = 100;
        const ctx = canvas.getContext('2d');
        ctx.save(); ctx.scale(-1, 1); ctx.drawImage(video, -100, 0, 100, 100); ctx.restore();
        
        selfieDataURL = canvas.toDataURL('image/jpeg', 0.4); 

        wrapper.style.display = 'none'; video.srcObject = null;
        streamReference.getTracks().forEach(track => track.stop()); 

        preview.src = selfieDataURL; preview.style.display = 'block';
        btnCapture.classList.add('hidden'); btnStart.disabled = false; btnStart.style.opacity = '1';
    }

    function initGame() {
        playerName = document.getElementById('player-name-input').value.trim();
        if(!playerName || !selfieDataURL) { alert("‚ùå ‡πÇ‡∏õ‡∏£‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö!"); return; }

        document.getElementById('header-player-img').src = selfieDataURL;
        document.getElementById('header-player-img').classList.remove('hidden');
        document.getElementById('display-player-name').innerText = playerName;
        document.getElementById('overlay-start').classList.add('hidden');
        startLevel();
    }
    
    startCamera();

    function startLevel() {
        document.getElementById('overlay-level-clear').classList.add('hidden');
        document.getElementById('level-display').innerText = levels[currentLevel].title;
        document.getElementById('no-order-msg').classList.add('hidden');
        
        spawnQueue = JSON.parse(JSON.stringify(levels[currentLevel].orders));
        activeOrders = []; timeToNextSpawn = 0; blendedStock = 4; singleBrewSlots = 0;
        
        levelScore = 0; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        levelWaitTimes = []; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        
        updateUI(); document.getElementById('tickets-container').innerHTML = ""; 

        clearInterval(globalTimer);
        globalTimer = setInterval(() => {
            if (spawnQueue.length > 0) {
                timeToNextSpawn--;
                if (timeToNextSpawn <= 0) {
                    let maxSpawn = currentLevel >= 8 ? 3 : (currentLevel >= 4 ? 2 : 1);
                    let numToSpawn = Math.floor(Math.random() * maxSpawn) + 1; 
                    for(let i=0; i<numToSpawn; i++) {
                        if(spawnQueue.length > 0) {
                            let newOrder = spawnQueue.shift(); 
                            newOrder.spawnTime = Date.now(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠
                            activeOrders.push(newOrder); 
                            appendTicketToDOM(newOrder); 
                            setTimeout(() => { const c = document.getElementById('tickets-container'); c.scrollLeft = c.scrollWidth; }, 100);
                        }
                    }
                    timeToNextSpawn = levels[currentLevel].spawnBaseRate + Math.floor(Math.random() * 2); 
                }
            }
            activeOrders.forEach(order => { order.timeLeft--; });
            updateTimersUI(); checkLevelCompletion();
        }, 1000);
    }

    function appendTicketToDOM(order) {
        const container = document.getElementById('tickets-container');
        const div = document.createElement('div'); div.className = 'ticket'; div.id = `ticket-${order.id}`;
        let html = `<h3>‡∏Ñ‡∏¥‡∏ß #${order.id} <span class="timer-text" style="color:#666">‚è± ${order.timeLeft}s</span></h3>
            <div class="ticket-timer-bg"><div class="ticket-timer-fill" style="width: 100%; background-color: var(--success);"></div></div><div id="stamp-${order.id}"></div>`;
        order.items.forEach((item, index) => {
            let badgeText = ""; let badgeClass = `bg-${item.type}`;
            if (item.type === 'hot') { badgeText = "ü´ñ"; } else if (item.type === 'single') { badgeText = "SIN"; }
            else if (item.type === 'blended') { badgeText = "BLE"; } else if (item.type === 'dessert') { badgeText = "DES"; }
            html += `<div class="order-item" id="item-${order.id}-${index}"><span class="badge ${badgeClass}">${badgeText}</span>${item.name}</div>`;
        });
        div.innerHTML = html; container.appendChild(div);
        document.getElementById('order-count-badge').innerText = `‡∏£‡∏≠‡∏û‡πà‡∏ô: ${spawnQueue.length}`;
        document.getElementById('active-count-badge').innerText = `‡∏ö‡∏ô‡∏à‡∏≠: ${activeOrders.length}`;
    }

    function updateTimersUI() {
        activeOrders.forEach(order => {
            const ticketEl = document.getElementById(`ticket-${order.id}`);
            if (!ticketEl) return;
            const timeSpan = ticketEl.querySelector('.timer-text'); const fillBar = ticketEl.querySelector('.ticket-timer-fill');
            if (timeSpan && fillBar) {
                const percent = (order.timeLeft / order.timeLimit) * 100;
                timeSpan.innerText = `‚è± ${order.timeLeft}s`; 
                let barColor = "var(--success)";
                if (order.timeLeft <= 0) { barColor = "var(--danger)"; timeSpan.style.color = "var(--danger)"; if (order.status !== 'ready') ticketEl.style.borderColor = "var(--danger)"; } 
                else if (percent <= 30) { barColor = "#ff9800"; timeSpan.style.color = "#666"; }
                fillBar.style.width = `${Math.max(0, percent)}%`; fillBar.style.backgroundColor = barColor;
            }
        });
        let readyCount = activeOrders.filter(o => o.status === 'ready').length;
        document.getElementById('ready-count').innerText = readyCount;
        const serveBtn = document.getElementById('btn-serve-tray');
        if (readyCount > 0) serveBtn.classList.remove('disabled'); else serveBtn.classList.add('disabled');
    }

    function checkOffItem(typeCompleted) {
        if (activeOrders.length === 0) return; let foundMatch = false;
        for (let order of activeOrders) {
            if (order.status === 'ready') continue; 
            for (let i = 0; i < order.items.length; i++) {
                if (order.items[i].type === typeCompleted && !order.items[i].done) {
                    order.items[i].done = true; foundMatch = true; 
                    levelScore += 20; totalScore += 20; // ‡∏ö‡∏ß‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà
                    let itemEl = document.getElementById(`item-${order.id}-${i}`); if(itemEl) itemEl.classList.add('done');
                    break;
                }
            }
            if(foundMatch) break;
        }
        if (foundMatch) {
            for (let order of activeOrders) {
                if (order.status !== 'ready' && order.items.every(item => item.done)) {
                    order.status = 'ready'; 
                    let ticketEl = document.getElementById(`ticket-${order.id}`); if(ticketEl) ticketEl.classList.add('ready');
                    let stampEl = document.getElementById(`stamp-${order.id}`); if(stampEl) stampEl.innerHTML = `<div class="ready-stamp">‚úÖ ‡∏£‡∏≠‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü!</div>`;
                }
            }
            updateUI(); updateTimersUI();
        }
    }

    function serveOrders() {
        let readyOrders = activeOrders.filter(o => o.status === 'ready');
        if (readyOrders.length === 0) return; 
        let toServe = readyOrders.slice(0, 4); 
        toServe.forEach(order => {
            // ‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ KPI ‡∏Ç‡∏≠‡∏á‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
            let waitTimeSec = (Date.now() - order.spawnTime) / 1000;
            levelWaitTimes.push(waitTimeSec);

            let speedBonus = order.timeLeft > 0 ? order.timeLeft * 10 : 0; 
            levelScore += (50 + speedBonus); totalScore += (50 + speedBonus);
            
            showFloatingScore(`+${50 + speedBonus}`, `ticket-${order.id}`);
            let ticketEl = document.getElementById(`ticket-${order.id}`);
            if(ticketEl) { ticketEl.style.transform = "scale(0)"; ticketEl.style.opacity = "0"; setTimeout(() => ticketEl.remove(), 200); }
            let idx = activeOrders.findIndex(o => o.id === order.id); if (idx > -1) activeOrders.splice(idx, 1);
        });
        document.getElementById('active-count-badge').innerText = `‡∏ö‡∏ô‡∏à‡∏≠: ${activeOrders.length}`;
        updateUI(); updateTimersUI(); checkLevelCompletion();
    }

    function checkLevelCompletion() {
        const serveBtn = document.getElementById('btn-serve-tray');
        if (activeOrders.length === 0 && spawnQueue.length === 0) {
            document.getElementById('no-order-msg').classList.remove('hidden');
            serveBtn.classList.add('disabled'); clearInterval(globalTimer);
            
            setTimeout(() => {
                // üî¥ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• KPI ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ üî¥
                let sumWait = levelWaitTimes.reduce((a, b) => a + b, 0);
                let avgWaitGameSec = levelWaitTimes.length > 0 ? (sumWait / levelWaitTimes.length) : 0;
                let avgWaitRealMin = parseFloat((avgWaitGameSec * 0.25).toFixed(1)); 
                
                document.getElementById('avg-time-game').innerText = avgWaitGameSec.toFixed(1);
                document.getElementById('avg-time-real').innerText = avgWaitRealMin;
                document.getElementById('level-score-display').innerText = levelScore;

                let kpiStatus = document.getElementById('kpi-status');
                
                // ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏î‡πà‡∏≤‡∏ô
                const clearOverlay = document.getElementById('overlay-level-clear');
                document.getElementById('action-buttons').classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô
                clearOverlay.classList.remove('hidden');
                
                // üü¢ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Auto-Save ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏à‡∏ö‡∏î‡πà‡∏≤‡∏ô üü¢
                autoSaveAndFetchLeaderboard(avgWaitRealMin, currentLevel + 1);

            }, 1000);
        }
    }

    function autoSaveAndFetchLeaderboard(myAvgWaitRealMin, lvl) {
        document.getElementById('kpi-compare-status').innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô...";
        document.getElementById('global-avg-time').innerText = "...";
        document.getElementById('leaderboard-list').innerHTML = "<div style='text-align:center; padding: 15px; color:#888; font-size:10px;'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå...</div>";
        document.getElementById('lb-title').innerText = `üèÜ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏ô‡∏ä‡∏á‡πÑ‡∏ß (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏î‡πà‡∏≤‡∏ô ${lvl})`;

        const payload = { 
            name: playerName, 
            score: levelScore,  // ‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏î‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏Ç‡πà‡∏á
            levelReached: lvl,  // ‡∏ö‡πà‡∏á‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏î‡πà‡∏≤‡∏ô‡πÑ‡∏´‡∏ô
            selfie: selfieDataURL,
            avgWaitTime: myAvgWaitRealMin 
        };

        const formData = new URLSearchParams();
        formData.append('data', JSON.stringify(payload));

        fetch(GOOGLE_APP_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData.toString()
        })
        .then(() => {
            fetchAndRenderLevelLeaderboard(lvl, myAvgWaitRealMin);
        })
        .catch(err => {
            fetchAndRenderLevelLeaderboard(lvl, myAvgWaitRealMin); // ‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡πá‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡∏≠‡∏¢‡∏π‡πà‡∏î‡∏µ
        });
    }

    async function fetchAndRenderLevelLeaderboard(lvl, myAvgWaitMin) {
        const listDiv = document.getElementById('leaderboard-list');
        try {
            const response = await fetch(GOOGLE_APP_SCRIPT_URL);
            const globalLb = await response.json();
            listDiv.innerHTML = "";
            
            // üî¥ ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏≤‡∏°‡∏≤ "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô üî¥
            let levelData = globalLb.filter(entry => entry.level === lvl);
            
            if(levelData.length === 0) {
                listDiv.innerHTML = "<div style='text-align:center; padding: 15px; color:#888; font-size:10px;'>‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏ö‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ!</div>"; 
                document.getElementById('global-avg-time').innerText = "-";
            } else {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
                let globalValidWaits = levelData.filter(entry => entry.avgWait > 0);
                if(globalValidWaits.length > 0) {
                    let totalGlobalWait = globalValidWaits.reduce((sum, entry) => sum + entry.avgWait, 0);
                    let globalAvgWait = (totalGlobalWait / globalValidWaits.length).toFixed(1);
                    document.getElementById('global-avg-time').innerText = globalAvgWait;
                    
                    let compareStatus = document.getElementById('kpi-compare-status');
                    if(myAvgWaitMin <= globalAvgWait) {
                        compareStatus.innerText = `üî• ‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ ${(globalAvgWait - myAvgWaitMin).toFixed(1)} ‡∏ô‡∏≤‡∏ó‡∏µ!`;
                        compareStatus.style.color = "var(--success)";
                    } else {
                        compareStatus.innerText = `üê¢ ‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ ${(myAvgWaitMin - globalAvgWait).toFixed(1)} ‡∏ô‡∏≤‡∏ó‡∏µ`;
                        compareStatus.style.color = "var(--danger)";
                    }
                }

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î)
                levelData.sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    return a.avgWait - b.avgWait; 
                });

                // ‡∏ß‡∏≤‡∏î Leaderboard ‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
                levelData.slice(0, 5).forEach((entry, index) => {
                    let imgSrc = (entry.selfie && entry.selfie.length > 100) ? entry.selfie : "IMG_4511.jpeg";
                    let rowHtml = `
                        <div class="leaderboard-row">
                            <span class="lb-rank">${index + 1}.</span>
                            <span style="flex:1; display:flex; align-items:center;">
                                <img src="${imgSrc}" alt="User" class="player-img-lb" onerror="this.src='IMG_4511.jpeg'">
                                ${entry.name} <span style="font-size:7px; color:#888; margin-left:3px;">| ‚è±Ô∏è ${entry.avgWait}m</span>
                            </span>
                            <span style="font-weight:bold;">${entry.score} pts</span>
                        </div>`;
                    listDiv.innerHTML += rowHtml;
                });
            }

            // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ï‡πà‡∏≠
            document.getElementById('action-buttons').classList.remove('hidden');
            if(lvl < levels.length) {
                document.getElementById('clear-title').innerText = `‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏î‡πà‡∏≤‡∏ô ${lvl} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;
                document.getElementById('btn-continue').classList.remove('hidden');
            } else {
                document.getElementById('clear-title').innerText = "üéâ THE ULTIMATE BARISTA!";
                document.getElementById('btn-continue').classList.add('hidden'); 
            }
            
        } catch (error) { 
            listDiv.innerHTML = "<div style='text-align:center; padding: 15px; color: var(--danger); font-size:10px;'>‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå)</div>"; 
            document.getElementById('action-buttons').classList.remove('hidden');
        }
    }

    function startNextLevel() {
        currentLevel++;
        startLevel();
    }

    function brewSingleTea() {
        if (singleBrewSlots >= 4) return; singleBrewSlots++; const currentSlot = singleBrewSlots;
        const fill = document.getElementById(`slot-fill-${currentSlot}`), text = document.getElementById(`slot-text-${currentSlot}`), btn = document.getElementById('btn-single');
        text.innerText = "‡∏™‡∏Å‡∏±‡∏î..."; fill.style.transition = 'none'; fill.style.width = '0%'; if(singleBrewSlots >= 4) btn.disabled = true;
        setTimeout(() => { fill.style.transition = `width 8000ms linear`; fill.style.width = '100%'; }, 50);
        setTimeout(() => { singleBrewSlots--; btn.disabled = false; text.innerText = "‡∏ß‡πà‡∏≤‡∏á"; fill.style.transition = 'none'; fill.style.width = '0%'; checkOffItem('single'); }, 8000);
    }

    function doTask(type, duration, btnId) {
        const btn = document.getElementById(btnId), progBar = document.getElementById(`prog-${type}`), fill = document.getElementById(`fill-${type}`);
        btn.disabled = true; progBar.style.display = 'block'; fill.style.transition = 'none'; fill.style.width = '0%';
        setTimeout(() => { fill.style.transition = `width ${duration}ms linear`; fill.style.width = '100%'; }, 50);
        setTimeout(() => { btn.disabled = false; progBar.style.display = 'none'; checkOffItem(type); }, duration);
    }

    function pourBlended() { if (blendedStock > 0) { blendedStock--; updateUI(); checkOffItem('blended'); } }
    function refillGallon() {
        if (blendedStock > 0) return; const btn1 = document.getElementById('btn-blend-pour'), btn2 = document.getElementById('btn-blend-refill'), progBar = document.getElementById('prog-refill'), fill = document.getElementById('fill-refill');
        btn1.disabled = true; btn2.disabled = true; progBar.style.display = 'block'; fill.style.transition = 'none'; fill.style.width = '0%';
        setTimeout(() => { fill.style.transition = `width 10000ms linear`; fill.style.width = '100%'; }, 50);
        setTimeout(() => { btn1.disabled = false; progBar.style.display = 'none'; blendedStock = 4; updateUI(); }, 10000);
    }

    function showFloatingScore(text, elementId) {
        const target = document.getElementById(elementId); if(!target) return;
        const floatEl = document.createElement('div'); floatEl.className = 'score-popup'; floatEl.innerText = text; floatEl.style.left = '30%'; floatEl.style.top = '10%'; target.appendChild(floatEl); setTimeout(() => floatEl.remove(), 1000);
    }

    function updateUI() {
        document.getElementById('total-score').innerText = totalScore; document.getElementById('blended-stock').innerText = blendedStock; document.getElementById('blended-stock').style.color = blendedStock === 0 ? 'var(--danger)' : 'var(--blended)';
        const btnRefill = document.getElementById('btn-blend-refill'); if (blendedStock > 0) { btnRefill.style.opacity = '0.5'; btnRefill.style.cursor = 'not-allowed'; } else { btnRefill.style.opacity = '1'; btnRefill.style.cursor = 'pointer'; btnRefill.disabled = false; }
    }
</script>

</body>
</html>
